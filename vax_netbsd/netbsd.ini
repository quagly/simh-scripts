; VAX - netbsd
; enable error trapping
set on

; general settings
set noquiet
set env HOME=/home/mwest
set env DATA_DIR=%HOME%/simh/vax-netbsd
set env SIMH_REPO_DIR=%HOME%/repos/simh
set env NETBSD_VERSION=10.0_RC4
set env NETBSD_ISO=%DATA_DIR%/NetBSD-%NETBSD_VERSION%-vax.iso
; prompt for root password
set env -p "root passwd" ROOT_PASSWD=rootT00R
; set env ROOT_PASSWD=roottoor  
; get entropy
; either prompt or from host cmd
; how to get STDOUT from host cmd? I don't see a way.
; dd if=/dev/random bs=32 count=1 status=none | openssl base64
set env -p "entropy string, output of `dd if=/dev/random bs=32 count=1 status=none | openssl base64`" ENTROPY=9d+5pjFpU4BEIAEWF0kJIvBvyp2JLJwmgVcn2WdLSXQ=
; prompt for user name
set env -p "user name: " USER=test
; prompt for user passwd
set env -p "%USER% password:" USER_PASSWD=testT35T

; log
; overwrite log with -n
set log -n %DATA_DIR%/install.log

; devices enabled by default
; set ts disable 
; set dz disable 
; set lpt disable 
; set rl disable 
; set ts disable 
; set tq disable 

; load boot rom to allow greater than 64MB RAM
; supports up to 512MB RAM
load -r %SIMH_REPO_DIR%/VAX/ka655x.bin
set rom nodelay

; CPU
;
; respond to boot, break, and kernel halt by entering interactive mode 
set cpu noautoboot
; kernel HALT returns to simulator
set cpu simhalt
; set 512 MB RAM
set cpu 512m 
; detect when idle and do not use host resources
set cpu idle=netbsd


; DISK
; remove disk if it exists
if exist %DATA_DIR%/netbsd-vax-install-ra92.vhd ! rm %DATA_DIR%/netbsd-vax-install-ra92.vhd
set rq0 ra92
set rq0 noautosize
set rq0 format=vhd
; set number of MB
set rq0 RAUSER=4000 
; create vhd format disk for os
; max file size is 2GB unless compiled with
; USE_ADDR64 when it is 1TB
attach rq0 -f vhd %DATA_DIR%/netbsd-vax-install-ra92.vhd


; ISO
; fetch iso if I don't have it
if not exist %NETBSD_ISO% curl https://cdn.netbsd.org/pub/NetBSD/images/%NETBSD_VERSION%/NetBSD-%NETBSD_VERSION%-vax.iso --output %NETBSD_ISO%
set rq1 cdrom
on OPENERR echof "attach iso status is: %STATUS%\nstatus description is: %TSTATUS%\n"; exit %STATUS%
; -r read-only
; -e file must exist
attach rq1 -r -e  %NETBSD_ISO%
on OPENERR


; NETWORK
; using nat for now
attach xq0 nat:
; boot cpu

:boot
; EXPECT 
; expect will execute in the order defined when multiple expects match
; by default each expect will only execute once and be cleared
; to see what expect lines are active `show expect`
; VMB prompt
; set default boot to disk
expect ">>>" send "set boot dua0\r"; continue
; boot install cd
expect ">>>" send "boot dua1\r"; continue

; put installer in separate file and call with DO?
:installer 
; installer is menu driven
; accept vt220 terminal
expect "Terminal type" send "\r"; echo "%DATETIME%\tcmd1"; continue
; use english
expect "enter key." send "\r"; echo "%DATETIME%\tcmd2"; continue 
; install to disk
expect "Install System" send "\r"; echo "%DATETIME%\tcmd3"; continue
; yes, really
expect "Yes or no?" send "b\r"; echo "%DATETIME%\tcmd4"; continue
; install on disk ra0
expect "Available disks" send "\r"; echo "%DATETIME%\tcmd5"; continue
; use default partitioning
expect "What would you like to do?" send "b\r"; echo "%DATETIME%\tcmd6";  continue
; Partition sizes ok 
expect "Partition sizes ok" send "\r"; echo "%DATETIME%\tcmd7"; continue
; Shall we continue?
expect "Shall we continue?" send "b\r"; echo "%DATETIME%\tcmd8"; continue
; modifying your disks
expect "Yes or no?" send "b\r"; echo "%DATETIME%\tcmd9"; continue
; one root partition 
expect "existing partition." send "x\r"; echo "%DATETIME%\tcmd10"; continue
; Status: Finished 
expect "Status: Finished" send "\r"; echo "%DATETIME%	cmd11"; continue
; install without X
; handy way to try different options.  How minimal is minimal?
expect "Select your distribution" send "b\r"; echo "%DATETIME%	cmd12"; continue
; partitions created
expect "MARKING FILE SYSTEM CLEAN" send "\r"; echo "%DATETIME%	cmd13"; continue
expect "Hit enter to echo continue" send "\r"; echo "%DATETIME\tcmd14"; continue
expect "Hit enter to echo continue" send "\r"; echo "%DATETIME\tcmd15"; continue
; use http
expect "Install from" send "b\r"; echo "%DATETIME%	cmd16"; continue
; use default network interface
expect "Available interfaces" send "\r"; echo "%DATETIME%	cmd17"; continue
; just return when prompted for network media type
expect "Network media type:" send "\r"; echo "%DATETIME%	cmd18"; continue
; auto configure network
expect "Perform autoconfiguration?" send "\r"; echo "%DATETIME%	cmd19"; continue 
; hostname
expect "Your host name:" send "vax_netbsd\r"; echo "%DATETIME%	cmd20"; continue
; no domain
expect "Your DNS domain:" send "\r"; echo "%DATETIME%	cmd21"; continue
; accept network configuration
expect "Are they OK?" send "\r"; echo "%DATETIME%	cmd22"; continue
; get distribution
expect "password is not needed" send "x\r"; echo "%DATETIME%	cmd23"; continue
; persist network config
expect "want it installed in /etc?" send "\r"; echo "%DATETIME%	cmd24"; continue
; additional configuration 
expect "essential things first." send "\r"; echo "%DATETIME%	cmd25"; continue
; root password
expect "New password:" send "%ROOT_PASSWD%\r"; echo "%DATETIME%	cmd26"; continue
expect "Retype new password:" send "%ROOT_PASSWD%\r"; echo "%DATETIME%	cmd27"; continue
; entropy
expect "option." send "a\r"; echo "%DATETIME%	cmd28"; continue
expect "may not be secure." send "%ENTROPY%\r"; echo "%DATETIME%	cmd29"; continue
; enable sshd
expect "Enable sshd" send "g\r"; echo "%DATETIME%	cmd30"; continue
; enable ntpd
expect "Enable ntpd" send "h\r"; echo "%DATETIME%	cmd31"; continue
; run ntpd on boot
expect "Run ntpdate at boot" send "i\r"; echo "%DATETIME%	cmd32"; continue
; add a user
expect "Add a user" send "o\r"; echo "%DATETIME%	cmd33"; continue
expect "8 character username to add" send "%USER%\r"; echo "%DATETIME%	cmd33"; continue
expect "Do you wish to add this user to group wheel?" send "\r"; echo "%DATETIME%	cmd34"; continue
expect "User shell" send "\r"; echo "%DATETIME%	cmd35"; continue
expect "New password:" send "%USER_PASSWD%\r"; echo "%DATETIME%	cmd36"; continue
expect "Retype new password:" send "%USER_PASSWD%\r"; echo "%DATETIME%	cmd37"; continue

show expect

; boot
boot cpu

; finished configuring
expect "Configure the additional items as needed." send "x\r"; echo "%DATETIME%	cmd37"; continue
; install to disk
expect "Install NetBSD to hard disk" send "\r"; echo "%DATETIME%	cmd38"; continue
expect "Shall we continue?" send "b\r"; echo "%DATETIME\tcmd39"; continue

show expect
